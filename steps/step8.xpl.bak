<plask loglevel="result">

<defines>
  <define name="lam_min" value="550"/>
  <define name="n_ref" value="4.0"/>
  <define name="n_layer" value="n_ref**0.5"/>
</defines>

<materials>
  <material name="mySi" base="Si">
    <absp>4300</absp>
  </material>
  <material name="mySiO2" base="SiO2">
    <Nr>n_layer</Nr>
  </material>
  <module name="si_nk"/>
</materials>

<geometry>
  <cartesian2d name="simple" axes="x,y " left="periodic" right="periodic" bottom="Si_Shinke">
    <stack>
      <rectangle name="layer_SiO2" material="SiO2" dx="1" dy="1"/>
      <rectangle name="layer_Si3N4" material="Si3N4" dx="1" dy="1"/>
    </stack>
  </cartesian2d>
</geometry>

<solvers>
  <optical name="OPTICAL" solver="Fourier2D" lib="modal">
    <geometry ref="simple"/>
    <expansion size="0"/>
  </optical>
</solvers>

<script><![CDATA[
import numpy as np
import matplotlib.pyplot as plt
import plask.material as pm

LAMS_MAP   = np.arange(500.0, 700.1, 2.0)    # nm (final heatmaps)
THETAS_MAP = np.arange(0.0, 70.1, 2.0)       # deg

LAMS_OBJ   = np.arange(500.0, 700.1, 10.0)   # nm (objective / tolerance / refinement)
THETAS_OBJ = np.arange(0.0, 70.1, 10.0)      # deg

SIDE   = "top"
EPS_NM = 5e-4

D1_NM0 = 36.684   # SiO2 (top)
D2_NM0 = 51.320   # Si3N4 (below)

L1 = GEO.layer_SiO2
L2 = GEO.layer_Si3N4

L1.material = pm.SiO2()              # dispersive SiO2
L2.material = pm.Si3N4()             # dispersive Si3N4

def set_stack(d1_nm, d2_nm):
    L1.height = max(float(d1_nm), EPS_NM) * 1e-3
    L2.height = max(float(d2_nm), EPS_NM) * 1e-3

def ktran_um(lam_nm, theta_deg, n0=1.0):
    return float(2e3 * np.pi / lam_nm * n0 * np.sin(np.deg2rad(theta_deg)))  # 1/um

def R_unpol(lam_nm, theta_deg):
    OPTICAL.ktran = ktran_um(lam_nm, theta_deg)
    Rte = float(OPTICAL.compute_reflectivity(float(lam_nm), SIDE, "TE"))
    Rtm = float(OPTICAL.compute_reflectivity(float(lam_nm), SIDE, "TM"))
    return 0.5 * (Rte + Rtm)

def mean_R_unpol(d1_nm, d2_nm, lams=LAMS_OBJ, thetas=THETAS_OBJ):
    set_stack(d1_nm, d2_nm)
    acc = 0.0
    for th in thetas:
        for lam in lams:
            acc += R_unpol(lam, th)
    return acc / (len(lams) * len(thetas))

def map_R_unpol(d1_nm, d2_nm, lams=LAMS_MAP, thetas=THETAS_MAP):
    set_stack(d1_nm, d2_nm)
    Z = np.empty((thetas.size, lams.size), float)
    for i, th in enumerate(thetas):
        for j, lam in enumerate(lams):
            Z[i, j] = R_unpol(lam, th)
    return Z

def refine_local(d1, d2, span=20.0, step=2.0, iters=2):
    d1, d2 = float(d1), float(d2)
    for _ in range(iters):
        g1 = np.arange(max(5.0, d1 - span), d1 + span + 1e-9, step)
        d1 = float(g1[np.argmin([mean_R_unpol(x, d2) for x in g1])])
        g2 = np.arange(max(5.0, d2 - span), d2 + span + 1e-9, step)
        d2 = float(g2[np.argmin([mean_R_unpol(d1, x) for x in g2])])
        span *= 0.5
        step = max(1.0, step * 0.5)
    return d1, d2

def tol_stats(d1, d2, tol, samples=24, seed=0):
    rng = np.random.default_rng(seed)
    Js = []
    for _ in range(samples):
        f1 = 1.0 + rng.uniform(-tol, tol)
        f2 = 1.0 + rng.uniform(-tol, tol)
        Js.append(mean_R_unpol(d1 * f1, d2 * f2))
    Js = np.asarray(Js, float)
    return float(Js.mean()), float(Js.max()), float(Js.min())

J0 = mean_R_unpol(D1_NM0, D2_NM0)
print_log("result", f"nominal (dispersive): d1={D1_NM0:.3f} nm, d2={D2_NM0:.3f} nm, meanR={J0:.6f}%")

D1_NM, D2_NM = refine_local(D1_NM0, D2_NM0)
J = mean_R_unpol(D1_NM, D2_NM)
print_log("result", f"refined (dispersive): d1={D1_NM:.3f} nm, d2={D2_NM:.3f} nm, meanR={J:.6f}%")

for tol in (0.02, 0.05):
    m, w, b = tol_stats(D1_NM, D2_NM, tol)
    print_log("result", f"tol ±{100*tol:.0f}%: mean={m:.6f}%  worst={w:.6f}%  best={b:.6f}% (MC)")

Ru_bare  = map_R_unpol(EPS_NM, EPS_NM)
Ru_stack = map_R_unpol(D1_NM, D2_NM)

def heatmap(Z, title, vmax):
    plt.figure(figsize=(8, 6))
    plt.pcolormesh(THETAS_MAP, LAMS_MAP, Z.T, shading="auto", vmin=0, vmax=vmax)
    plt.xlabel("Angle (deg)")
    plt.ylabel("Wavelength (nm)")
    plt.title(title)
    plt.colorbar(label="Reflectivity (%)")
    plt.tight_layout()

heatmap(Ru_bare,  "Bare Si (dispersive): unpolarized R(λ,θ)", vmax=50)
heatmap(Ru_stack, f"2-layer AR (dispersive): d1={D1_NM:.1f} nm, d2={D2_NM:.1f} nm", vmax=10)
plt.show()

]]></script>

</plask>
